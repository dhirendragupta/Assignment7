/*
 Node02 2015-03-30 
*/
var express=require("express"),app=express(),CRUD=require("./CRUD.js");app.get("/students/read",CRUD.read),app.post("/students/create",CRUD.create),app.put("/students/update",CRUD.update),app["delete"]("/students/delete",CRUD["delete"]),app.listen(3001),console.log("server started' on port 3001...");var parse=require("./parse.js"),Student=function(a,b,c,d){this.id=a,this.email=b,this.name=c,this.enrolledSubjects=d};exports.create=function(a,b){parse.parseRequestBody(a,function(a,c){var d=c.email,e=c.id,f=c.name,g=c.enrolledSubjects;parse.createStudent(new Student(e,d,f,g),function(a,c){parse.writToFile(),b.end("Create completed")})})},exports.read=function(a,b){"GET"==a.method&&(console.log("in get method"),parse.getStudents(function(a,c){return a?void b.write("Error"):(b.write(JSON.stringify(c)),void b.end("reading completed"))}))},exports.update=function(a,b){if(!a.query.email)return void b.send("Invalid Query parameter.");var c=a.query.email;parse.parseRequestBody(a,function(a,d){return a?void b.write("Error"):void parse.updateStudentByEmail(c,d,function(a,c){return a?void b.end(a):(parse.writToFile(),void b.end("Update Completed..."))})})},exports["delete"]=function(a,b){if(console.log(a.query.email),!a.query.email)return void b.send("Invalid Query parameter.");var c=a.query.email;parse.deleteStudentByEmail(c,function(a,c){return a?void b.end(a):(parse.writToFile(),void b.end("Record deleted"))})};var url=require("url"),fs=require("fs"),jf=require("jsonfile"),students=[];exports.parseRequestBody=function(a,b){var c="";a.on("readable",function(){var b=a.read();"string"==typeof b?c+=b:"object"==typeof b&&b instanceof Buffer&&(c+=b.toString("utf8"))}),a.on("end",function(){if(c){var a=JSON.parse(c);b(null,a)}})},exports.createStudent=function(a,b){students.push(a),0!=students.length&&b(null,a)},exports.updateStudentByEmail=function(a,b,c){for(var d=0,e=0;e<students.length;e++)students[e].email==a&&(d=1,students[e]=b);return 1!=d?void c("Record not found",b):void(0!=students.length&&c(null,b))},exports.getStudents=function(a){a(null,students)},exports.deleteStudentByEmail=function(a,b){for(var c,d=0;d<students.length-1;d++)students[d].email==a&&(c=1,students.splice(d,1));return 1!=c?void b("Records not found",students):void(students.length>=0&&b(null,students))};var insertInSub=function(){for(var a,b,c,d,e=[],f=[],g=[],h=0;h<=students.length-1;h++)for(var i=0;i<=students[h].enrolledSubjects.length-1;){switch(students[h].enrolledSubjects[i].subjectId){case"123":b=1;var j=students[h].enrolledSubjects[i].Score,k={id:students[h].id,score:j};e.push(k);break;case"124":c=2;var j=students[h].enrolledSubjects[i].Score,k={id:students[h].id,score:j};f.push(k);break;case"125":d=3;var j=students[h].enrolledSubjects[i].Score,k={id:students[h].id,score:j};g.push(k)}i++}1==b&&(a="./Sub1.json",writeJson(e,a)),2==c&&(a="./Sub2.json",writeJson(f,a)),3==d&&(a="./Sub3.json",writeJson(g,a))};exports.writToFile=function(){for(var a="./Student.json",b=[],c=0;c<=students.length-1;c++){var d={id:students[c].id,email:students[c].email};console.log(JSON.stringify(d)),b.push(d)}writeJson(b,a),insertInSub()};var writeJson=function(a,b){jf.writeFile(b,a,function(a){console.log("NOT error"+a)})};